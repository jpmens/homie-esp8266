# In official nodejs image, SSH deployment doesn't work
box: phusion/passenger-nodejs
build:
  steps:
    - npm-install
    - script:
        name: build site
        code: npm run dist
    - script:
        name: copy public directory
        code: cp -r public/ $WERCKER_OUTPUT_DIR
    - script:
        name: remove source map
        code: rm $WERCKER_OUTPUT_DIR/public/js/bundle.min.js.map
    - script:
        name: copy index.html
        code: cp index.html $WERCKER_OUTPUT_DIR
    - script:
        name: add config.xml
        code: cp config.xml $WERCKER_OUTPUT_DIR
    - script:
        name: add README
        code: cp README_BUILT.md $WERCKER_OUTPUT_DIR/README.md
    - script:
        name: bypass Jekyll
        code: touch $WERCKER_OUTPUT_DIR/.nojekyll

deploy:
  steps:
    - add-to-known_hosts:
        hostname: github.com
        fingerprint: ad:1c:08:a4:40:e3:6f:9c:f5:66:26:5d:4b:33:5d:8c
    - mktemp:
        envvar: PRIVATEKEY_PATH
    - create-file:
        name: write private key
        filename: $PRIVATEKEY_PATH
        content: $SSH_PRIVATE
        overwrite: true
        hide-from-log: true
    - script:
        name: configure git
        code: |-
          git config --global user.email "pleasemailus@wercker.com"
          git config --global user.name "wercker"
          rm -rf .git
    - script:
        name: deploy to GitHub Pages
        code: |-
          git init
          git checkout -b gh-pages
          git add .
          git commit -m "Deploy commit from $WERCKER_STARTED_BY ($WERCKER_GIT_OWNER/$WERCKER_GIT_REPOSITORY@$WERCKER_GIT_COMMIT)"
          git remote add origin git@github.com:marvinroger/homie-esp8266.git
          ssh-agent bash -c "ssh-add $PRIVATEKEY_PATH; git push -f origin gh-pages"
    - script:
        name: trigger PhoneGap Build
        code: curl -X PUT -d 'data={"pull":"true"}' https://build.phonegap.com/api/v1/apps/1906578?auth_token=$PGB_TOKEN
